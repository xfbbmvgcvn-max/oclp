name: OpenCore Patcher Auto Builder (.pkg universal)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 90

    steps:
      - name: Checkout empty workspace
        uses: actions/checkout@v4

      - name: Clone official OCLP source
        run: |
          echo "Cloning official Dortania OpenCore-Legacy-Patcher..."
          git clone --depth=1 https://github.com/dortania/OpenCore-Legacy-Patcher.git source
          echo "Source cloned."

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install wxPython pyinstaller macholib pyobjc

      - name: Temporary fix for py_sip_xnu
        run: |
          mkdir -p source/opencore_legacy_patcher/detections
          echo "Creating dummy py_sip_xnu module..."
          echo "def dummy(): return None" > source/opencore_legacy_patcher/detections/py_sip_xnu.py

      - name: Build OCLP GUI (auto)
        run: |
          cd source
          echo "Attempting to build OpenCore Patcher GUI..."
          if [ -f Build-Binary.py ]; then
            python3 Build-Binary.py --gui
          elif [ -f Scripts/Build-Binary.py ]; then
            python3 Scripts/Build-Binary.py --gui
          elif [ -f OpenCore-Patcher-GUI.command ]; then
            chmod +x OpenCore-Patcher-GUI.command
            ./OpenCore-Patcher-GUI.command --build || true
          elif [ -f Build.py ]; then
            python3 Build.py
          else
            echo "No known build script found, stopping."
            exit 1
          fi
          ls -lh ./dist || true

      - name: Locate built .app
        id: locate
        run: |
          APP_PATH=$(find source -type d -name "OpenCore-Patcher.app" -print -quit)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find source -type d -name "*.app" -print -quit)
          fi
          echo "Found app path: $APP_PATH"
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT

      - name: Package .pkg
        run: |
          mkdir -p dist/root/Applications
          cp -R "${{ steps.locate.outputs.app_path }}" dist/root/Applications/
          pkgbuild \
            --root dist/root \
            --identifier com.opencore.legacy.patcher \
            --version 3.0.0-nightly \
            --install-location / \
            dist/OpenCore-Patcher-Nightly.pkg
          echo ".pkg created successfully."
          ls -lh dist/

      - name: Upload .pkg artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenCore-Patcher-Nightly
          path: dist/OpenCore-Patcher-Nightly.pkg
          retention-days: 14
