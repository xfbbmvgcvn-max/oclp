name: OpenCore Patcher Nightly Auto Build (.pkg)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 90

    steps:
      - name: Checkout empty workspace
        uses: actions/checkout@v4

      - name: Clone official OCLP source
        run: |
          echo "â¬‡ï¸ Cloning Dortania OpenCore-Legacy-Patcher..."
          git clone --depth=1 https://github.com/dortania/OpenCore-Legacy-Patcher.git source
          cd source
          echo "âœ… Source cloned."

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install wxPython pyinstaller macholib || true

      - name: Build OpenCore-Patcher GUI
        run: |
          cd source
          echo "ðŸš€ Building OCLP GUI..."
          python3 Build-Binary.py --gui
          echo "âœ… Build complete."
          ls -lh ./dist || true

      - name: Locate built .app
        id: locate
        run: |
          APP_PATH=$(find source -type d -name "OpenCore-Patcher.app" -print -quit)
          echo "Found app path: $APP_PATH"
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT

      - name: Package .pkg
        run: |
          mkdir -p dist/root/Applications
          cp -R "${{ steps.locate.outputs.app_path }}" dist/root/Applications/
          pkgbuild \
            --root dist/root \
            --identifier com.opencore.legacy.patcher \
            --version 3.0.0-nightly \
            --install-location / \
            dist/OpenCore-Patcher-Nightly.pkg
          echo "âœ… .pkg created successfully."
          ls -lh dist/

      - name: Upload .pkg artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenCore-Patcher-Nightly
          path: dist/OpenCore-Patcher-Nightly.pkg
          retention-days: 14
